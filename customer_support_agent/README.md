# Agent Service
_Generated by AI_

This project implements a simple agent service with a FastAPI endpoint that accepts POST requests at `/invocations` and forwards them to the agent runtime

Agent is taken from: https://github.com/langchain-ai/langgraph/blob/main/docs/docs/tutorials/customer-support/customer-support.ipynb

## ðŸ†• PostgreSQL Support

**This project now supports PostgreSQL databases (Neon, Supabase, etc.) in addition to SQLite!**

For a complete migration guide, see:
- **[MIGRATION_GUIDE.md](MIGRATION_GUIDE.md)** - Step-by-step instructions
- **[MIGRATION_SUMMARY.md](MIGRATION_SUMMARY.md)** - Technical details and changes

### Quick Start with PostgreSQL

1. Create a database on [Neon](https://neon.tech) or [Supabase](https://supabase.com)
2. Run the interactive setup:
   ```bash
   python setup/quick_start.py
   ```
3. Or manually configure:
   ```bash
   cp .env.example .env
   # Edit .env with your DATABASE_URL
   python setup/migrate_to_postgres.py
   ```

## Requirements

- Python 3.10+ (project uses Python 3.13 bytecode in the workspace but 3.10+ is recommended)
- Install dependencies from `requirements.txt`:

```bash
pip install -r requirements.txt
```

## Configuration

The service requires API keys and database configuration. Set these as environment variables or in a `.env` file in the project root:

**Required:**
- `OPENAI_API_KEY` - your OpenAI API key
- `TAVILY_API_KEY` - your Tavily API key (note: was TRIVIY_API_KEY before)
- `DATABASE_URL` - PostgreSQL connection string (for remote database)

Example `.env` file for PostgreSQL:

```env
OPENAI_API_KEY=sk-...
TAVILY_API_KEY=tvly-...
DATABASE_URL=postgresql://user:password@host:port/database?sslmode=require
```

The project loads environment variables using `python-dotenv`.

## Initialize the database

### Option 1: PostgreSQL (Recommended for Production)

1. Create a PostgreSQL database on [Neon](https://neon.tech) or [Supabase](https://supabase.com)
2. Add your `DATABASE_URL` to `.env`
3. Run the migration script:

```bash
python setup/migrate_to_postgres.py
```

4. Verify the migration:

```bash
python setup/test_migration.py
```

### Option 2: SQLite (Legacy, Local Development Only)

Before starting the service, create and initialize the SQLite database:

```bash
python setup/db.py
```

This will create `travel2.sqlite` in the project root.

**Note:** The application has been updated to use PostgreSQL by default. SQLite support is maintained for backward compatibility but not recommended for production use.

## Running the FastAPI server

There are two ways to run the FastAPI app depending on the module that exposes the `app` instance:

- Run with `uvicorn` (recommended for development):

```bash
uvicorn app:app --reload
```

This starts the service on the default `http://127.0.0.1:8000`.

- Alternatively, if you use `main.py` as the entrypoint, run:

```bash
uvicorn main:app --reload
```

If you prefer launching the app directly from Python (less common), make sure the file contains a runnable ASGI entrypoint.

## Endpoint

POST /invocations

- Content-Type: `application/json`
- Payload shape (example):

```json
{
  "thread_id": 123,
  "passenger_id": "3442 587242",
  "question": "What is my flight status?"
}
```

Example curl request:

```bash
curl -X POST http://localhost:8000/invocations \
  -H "Content-Type: application/json" \
  -d '{"thread_id": 123, "passenger_id": "3442 587242", "question": "What is my flight status?"}'
```

## Notes & Troubleshooting

- Make sure your virtual environment is activated and `requirements.txt` packages are installed.
- If you see import errors related to `agent` or `db_utils`, verify that the project root is in `PYTHONPATH` (running `uvicorn` from the project root normally works).
- The `app.py` file imports `create_agent` from `agent.agent`. If the agent runtime requires additional configuration (for example, access to the APIs listed above), set those environment variables before starting the server.

## Next steps / Improvements

- Add automated tests for the `/invocations` endpoint.
- Add a small healthcheck endpoint (e.g., `GET /health`) that verifies database connectivity and required API keys.
